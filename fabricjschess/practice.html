// Timer Variables
let whiteTime = 300; // 5 minutes in seconds
let blackTime = 300;
let currentPlayer = "white"; // Start with white
let timerInterval;

// Timer Display
const whiteTimerDisplay = document.createElement("div");
whiteTimerDisplay.style.fontSize = "20px";
whiteTimerDisplay.style.color = "black";
whiteTimerDisplay.style.margin = "10px";
whiteTimerDisplay.textContent = "White Time: 5:00";
document.body.appendChild(whiteTimerDisplay);

const blackTimerDisplay = document.createElement("div");
blackTimerDisplay.style.fontSize = "20px";
blackTimerDisplay.style.color = "black";
blackTimerDisplay.style.margin = "10px";
blackTimerDisplay.textContent = "Black Time: 5:00";
document.body.appendChild(blackTimerDisplay);

// Update Timer Display
function updateTimerDisplay() {
  const whiteMinutes = Math.floor(whiteTime / 60);
  const whiteSeconds = whiteTime % 60;
  const blackMinutes = Math.floor(blackTime / 60);
  const blackSeconds = blackTime % 60;

  whiteTimerDisplay.textContent = `White Time: ${whiteMinutes}:${whiteSeconds
    .toString()
    .padStart(2, "0")}`;
  blackTimerDisplay.textContent = `Black Time: ${blackMinutes}:${blackSeconds
    .toString()
    .padStart(2, "0")}`;
}

// Switch Timer
function switchTimer() {
  clearInterval(timerInterval);
  if (currentPlayer === "white") {
    currentPlayer = "black";
    startTimer(() => blackTime--);
  } else {
    currentPlayer = "white";
    startTimer(() => whiteTime--);
  }
}

// Start Timer
function startTimer(decrementFunction) {
  timerInterval = setInterval(() => {
    decrementFunction();
    updateTimerDisplay();

    if (whiteTime <= 0 || blackTime <= 0) {
      clearInterval(timerInterval);
      alert(`${whiteTime <= 0 ? "Black" : "White"} wins by timeout!`);
    }
  }, 1000);
}

// Initialize Timer
startTimer(() => whiteTime--);

// Example: Call switchTimer() when a player makes a move.
canvas.on("mouse:down", (e) => {
  const mouseX = e.pointer.x;
  const mouseY = e.pointer.y;

  if (selectedPiece && !movingPiece) {
    movingPiece = true;

    const col = Math.floor(mouseX / tileSize);
    const row = Math.floor(mouseY / tileSize);

    if (col >= 0 && col < 8 && row >= 0 && row < 8) {
      selectedPiece.left = col * tileSize;
      selectedPiece.top = row * tileSize;

      if (ttsEnabled) {
        const position = `${String.fromCharCode(65 + col)}${8 - row}`;
        const message = `${selectedPiece.name} to ${position}`;
        const utterance = new SpeechSynthesisUtterance(message);
        utterance.rate = 1;
        utterance.pitch = 1;
        speechSynthesis.speak(utterance);
      }

      selectedPiece = null;
      canvas.renderAll();

      // Switch Timer After Move
      switchTimer();
    }

    movingPiece = false;
  }
});
