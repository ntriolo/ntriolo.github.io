<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fabric.js Chess Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.2.4/fabric.min.js"></script>
  <style>
    canvas {
      border: 1px solid black;
    }
  </style>
</head>
<body>
  <h1>Fabric.js Chess Game</h1>
  <button id="startRestart">Start/Restart Game</button>
  <div>
    <canvas id="chessboard" width="480" height="480"></canvas>
  </div>

  <script>
    const canvas = new fabric.Canvas('chessboard');
    const squareSize = 60; // Size of each square (480px board / 8 squares)
    const boardSize = 8;
    let pieces = []; // Store piece objects

    // Initialize the chessboard
    function drawBoard() {
      canvas.clear();
      for (let row = 0; row < boardSize; row++) {
        for (let col = 0; col < boardSize; col++) {
          const isWhite = (row + col) % 2 === 0;
          const rect = new fabric.Rect({
            left: col * squareSize,
            top: row * squareSize,
            width: squareSize,
            height: squareSize,
            fill: isWhite ? '#f0d9b5' : '#b58863',
            selectable: false,
          });
          canvas.add(rect);
        }
      }
    }

    // Create chess pieces
    function createPieces() {
      const piecePositions = {
        // Initial positions: black (uppercase), white (lowercase)
        'RNBQKBNR': 0, // Row 0 for black
        'PPPPPPPP': 1, // Row 1 for black
        'pppppppp': 6, // Row 6 for white
        'rnbqkbnr': 7  // Row 7 for white
      };

      for (const [rowConfig, rowIndex] of Object.entries(piecePositions)) {
        for (let col = 0; col < rowConfig.length; col++) {
          const pieceChar = rowConfig[col];
          const pieceColor = pieceChar === pieceChar.toLowerCase() ? 'white' : 'black';

          const piece = new fabric.Text(pieceChar, {
            left: col * squareSize + squareSize / 4,
            top: rowIndex * squareSize + squareSize / 4,
            fontSize: 40,
            fill: pieceColor,
            originX: 'center',
            originY: 'center',
            selectable: true,
            hasControls: false,
            pieceType: pieceChar,
            color: pieceColor,
          });

          pieces.push(piece);
          canvas.add(piece);
        }
      }
    }

    // Handle piece movement
    function setupPieceMovement() {
      canvas.on('object:moving', (e) => {
        const piece = e.target;
        const left = Math.round(piece.left / squareSize) * squareSize;
        const top = Math.round(piece.top / squareSize) * squareSize;

        piece.set({ left, top });
      });

      canvas.on('object:moved', (e) => {
        const piece = e.target;

        // TODO: Implement move validation and capturing logic

        // Example TTS announcement
        const move = `${piece.color} ${piece.pieceType} moved`;
        speechSynthesis.speak(new SpeechSynthesisUtterance(move));
      });
    }

    // Initialize the game
    function startGame() {
      drawBoard();
      createPieces();
      setupPieceMovement();
    }

    // Add Start/Restart functionality
    document.getElementById('startRestart').addEventListener('click', () => {
      startGame();
    });

    // Load the board on page load
    startGame();
  </script>
</body>
</html>
